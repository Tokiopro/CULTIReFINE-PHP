<?php
// ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆã‚’æœ‰åŠ¹ã«ã™ã‚‹ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
error_reporting(E_ALL);
ini_set('display_errors', 1);

// ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹å‰ã«ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ
try {
    session_start();
} catch (Exception $e) {
    die("ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã‚¨ãƒ©ãƒ¼: " . $e->getMessage());
}

// ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ãƒã‚§ãƒƒã‚¯
$urlHelperPath = __DIR__ . '/../line-auth/url-helper.php';
if (!file_exists($urlHelperPath)) {
    die("url-helper.phpãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " . $urlHelperPath);
}

try {
    require_once $urlHelperPath;
} catch (Exception $e) {
    die("url-helper.phpèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " . $e->getMessage());
}

// LINEèªè¨¼ãƒã‚§ãƒƒã‚¯
if (!isset($_SESSION['line_user_id'])) {
    // æœªèªè¨¼ã®å ´åˆã¯LINEèªè¨¼ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    if (function_exists('getRedirectUrl')) {
        header('Location: ' . getRedirectUrl('/reserve/line-auth/'));
        exit;
    } else {
        die("getRedirectUrlé–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“");
    }
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
$lineUserId = $_SESSION['line_user_id'];
$displayName = $_SESSION['line_display_name'] ?? 'ã‚²ã‚¹ãƒˆ';
$pictureUrl = $_SESSION['line_picture_url'] ?? null;
$userData = $_SESSION['user_data'] ?? null;
$userData = $_SESSION['user_data'] ?? null;

// GAS APIè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
$configPath = __DIR__ . '/../line-auth/config.php';
$gasApiPath = __DIR__ . '/../line-auth/GasApiClient.php';

$configExists = file_exists($configPath);
$gasApiExists = file_exists($gasApiPath);

// æ›¸é¡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
$docsData = [];
$errorMessage = '';
$hasError = false;
$debugInfo = [];

// ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’åé›†
$debugInfo['config_exists'] = $configExists;
$debugInfo['gasapi_exists'] = $gasApiExists;
$debugInfo['line_user_id'] = $lineUserId;
$debugInfo['session_data'] = $_SESSION;

if ($configExists && $gasApiExists) {
    try {
    require_once $configPath;
    require_once $gasApiPath;
    
    // GasApiClientã‚¯ãƒ©ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if (!class_exists('GasApiClient')) {
        throw new Exception("GasApiClientã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    }
    
    // æ­£ã—ã„åˆæœŸåŒ–æ–¹æ³•
    $gasApi = new GasApiClient(GAS_DEPLOYMENT_ID, GAS_API_KEY);
    $debugInfo['gasapi_created'] = true;
        
        // APIå‘¼ã³å‡ºã—
        $result = $gasApi->getUserFullInfo($lineUserId);
        $debugInfo['api_result'] = $result;
        
        if ($result['docsinfo'] === 'success' && isset($result['data']['docsinfo'])) {
            $docsData = $result['data']['docsinfo'];
            $debugInfo['docs_count'] = count($docsData);
        } elseif ($result['docsinfo'] === 'error') {
            $hasError = true;
            $errorMessage = $result['error']['message'] ?? 'æ›¸é¡ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        } else {
            // æˆåŠŸã ãŒæ›¸é¡ãƒ‡ãƒ¼ã‚¿ãªã—
            $debugInfo['no_docsinfo'] = true;
        }
        
    } catch (Exception $e) {
        $hasError = true;
        $errorMessage = 'æ›¸é¡ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' . $e->getMessage();
        $debugInfo['exception'] = $e->getMessage();
        $debugInfo['exception_trace'] = $e->getTraceAsString();
    }
} else {
    $hasError = true;
    $errorMessage = 'å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
    if (!$configExists) $errorMessage .= ' config.php';
    if (!$gasApiExists) $errorMessage .= ' GasApiClient.php';
}

// Google Driveã®URLã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã«å¤‰æ›ã™ã‚‹é–¢æ•°
function convertToPreviewUrl($url) {
    if (empty($url)) return '';
    
    if (preg_match('/\/d\/([a-zA-Z0-9-_]+)/', $url, $matches)) {
        $fileId = $matches[1];
        return "https://drive.google.com/file/d/{$fileId}/preview";
    }
    return $url;
}

// æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°
function formatDate($dateString) {
    if (empty($dateString)) return 'æ—¥ä»˜ä¸æ˜';
    
    try {
        $date = new DateTime($dateString);
        return $date->format('Yå¹´mæœˆdæ—¥');
    } catch (Exception $e) {
        return $dateString;
    }
}

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
function canPreview($url) {
    return !empty($url) && strpos($url, 'drive.google.com') !== false;
}
?>
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CLUTIREFINEã‚¯ãƒªãƒ‹ãƒƒã‚¯ æ›¸é¡ä¸€è¦§ (ãƒ‡ãƒãƒƒã‚°ç‰ˆ)</title>
<meta name="description" content="CLUTIREFINEã‚¯ãƒªãƒ‹ãƒƒã‚¯ã®æ›¸é¡ä¸€è¦§">
<!-- Tailwind CSS CDN --> 
<script src="https://cdn.tailwindcss.com"></script>
<style>
.debug-info {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    margin: 1rem 0;
    font-family: monospace;
    font-size: 0.875rem;
}
.debug-info pre {
    white-space: pre-wrap;
    word-break: break-all;
}
</style>
</head>
<body>
<!-- Header -->
<header class="bg-teal-600 text-white p-4 shadow-md sticky top-0 z-50">
  <div class="container mx-auto flex justify-between items-center">
    <h1 class="text-xl font-semibold">CLUTIREFINEã‚¯ãƒªãƒ‹ãƒƒã‚¯<br class="sp">
      æ›¸é¡ä¸€è¦§ (ãƒ‡ãƒãƒƒã‚°ç‰ˆ)</h1>
  </div>
</header>

<!-- Main Content -->
<main class="flex-1 py-6 min-h-screen bg-gray-100">
  <div class="container mx-auto px-4">
    
    <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
    <div class="debug-info mb-6">
      <h3 class="font-bold mb-2">ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h3>
      <pre><?php echo json_encode($debugInfo, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE); ?></pre>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
    <?php if ($hasError): ?>
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        <h4 class="font-bold">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h4>
        <p><?php echo htmlspecialchars($errorMessage, ENT_QUOTES, 'UTF-8'); ?></p>
      </div>
    <?php endif; ?>

    <!-- æ›¸é¡ä¸€è¦§ -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-2xl font-bold mb-4">æ›¸é¡ä¸€è¦§</h2>
      
      <?php if (!$hasError && empty($docsData)): ?>
        <div class="bg-gray-100 border border-gray-300 text-gray-600 px-4 py-6 rounded text-center">
          <p>ç¾åœ¨ã€æ›¸é¡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        </div>
      <?php endif; ?>

      <?php if (!$hasError && !empty($docsData)): ?>
        <div class="mb-4">
          <p class="text-sm text-gray-600">æ›¸é¡ä»¶æ•°: <?php echo count($docsData); ?>ä»¶</p>
        </div>

        <div class="space-y-4">
          <?php foreach ($docsData as $index => $doc): ?>
            <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <h3 class="font-medium text-gray-900 mb-1">æ›¸é¡å</h3>
                  <p class="text-gray-700"><?php echo htmlspecialchars($doc['docs_name'] ?? 'åç§°æœªè¨­å®š', ENT_QUOTES, 'UTF-8'); ?></p>
                  <p class="text-xs text-gray-500 mt-1">
                    ID: <?php echo htmlspecialchars($doc['docs_id'] ?? '', ENT_QUOTES, 'UTF-8'); ?>
                  </p>
                </div>
                
                <div>
                  <h3 class="font-medium text-gray-900 mb-1">ä½œæˆæ—¥</h3>
                  <p class="text-gray-700">
                    <?php 
                    if (isset($doc['created_at'])) {
                      echo htmlspecialchars(formatDate($doc['created_at']), ENT_QUOTES, 'UTF-8');
                    } else {
                      echo 'æ—¥ä»˜ä¸æ˜';
                    }
                    ?>
                  </p>
                </div>
                
                <div class="flex items-center">
                  <?php if (isset($doc['docs_url']) && canPreview($doc['docs_url'])): ?>
                    <a class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors" 
                       href="<?php echo htmlspecialchars(convertToPreviewUrl($doc['docs_url']), ENT_QUOTES, 'UTF-8'); ?>" 
                       target="_blank" 
                       rel="noopener noreferrer">
                      ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦‹ã‚‹
                    </a>
                  <?php else: ?>
                    <span class="bg-gray-400 text-white px-4 py-2 rounded cursor-not-allowed">
                      ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸å¯
                    </span>
                  <?php endif; ?>
                </div>
              </div>
              
              <!-- å€‹åˆ¥ã®æ›¸é¡ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
              <details class="mt-4">
                <summary class="cursor-pointer text-sm text-gray-500">æ›¸é¡ãƒ‡ãƒ¼ã‚¿ã®è©³ç´°</summary>
                <pre class="mt-2 text-xs bg-gray-100 p-2 rounded"><?php echo json_encode($doc, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE); ?></pre>
              </details>
            </div>
          <?php endforeach; ?>
        </div>
      <?php endif; ?>
    </div>

    <!-- ç’°å¢ƒæƒ…å ± -->
    <div class="debug-info mt-6">
      <h3 class="font-bold mb-2">ğŸŒ ç’°å¢ƒæƒ…å ±</h3>
      <ul class="space-y-1">
        <li>PHP Version: <?php echo PHP_VERSION; ?></li>
        <li>Current Directory: <?php echo __DIR__; ?></li>
        <li>Include Path: <?php echo get_include_path(); ?></li>
        <li>Memory Usage: <?php echo memory_get_usage(true) / 1024 / 1024; ?> MB</li>
        <li>Session ID: <?php echo session_id(); ?></li>
      </ul>
    </div>
  </div>
</main>

<script>
console.log('ãƒ‡ãƒãƒƒã‚°æƒ…å ±:', <?php echo json_encode($debugInfo); ?>);
</script>

</body>
</html>