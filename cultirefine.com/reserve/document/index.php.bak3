<?php
// エラーレポートを有効にする（デバッグ用）
error_reporting(E_ALL);
ini_set('display_errors', 1);

// セッション開始前にエラーをキャッチ
try {
    session_start();
} catch (Exception $e) {
    die("セッション開始エラー: " . $e->getMessage());
}

// ファイル存在チェック
$urlHelperPath = __DIR__ . '/../line-auth/url-helper.php';
if (!file_exists($urlHelperPath)) {
    die("url-helper.phpが見つかりません: " . $urlHelperPath);
}

try {
    require_once $urlHelperPath;
} catch (Exception $e) {
    die("url-helper.php読み込みエラー: " . $e->getMessage());
}

// LINE認証チェック
if (!isset($_SESSION['line_user_id'])) {
    // 未認証の場合はLINE認証へリダイレクト
    if (function_exists('getRedirectUrl')) {
        header('Location: ' . getRedirectUrl('/reserve/line-auth/'));
        exit;
    } else {
        die("getRedirectUrl関数が定義されていません");
    }
}

// ユーザー情報を取得
$lineUserId = $_SESSION['line_user_id'];
$displayName = $_SESSION['line_display_name'] ?? 'ゲスト';
$pictureUrl = $_SESSION['line_picture_url'] ?? null;
$userData = $_SESSION['user_data'] ?? null;
$userData = $_SESSION['user_data'] ?? null;

// GAS API設定ファイルの存在確認
$configPath = __DIR__ . '/../line-auth/config.php';
$gasApiPath = __DIR__ . '/../line-auth/GasApiClient.php';

$configExists = file_exists($configPath);
$gasApiExists = file_exists($gasApiPath);

// 書類データを取得
$docsData = [];
$errorMessage = '';
$hasError = false;
$debugInfo = [];

// デバッグ情報を収集
$debugInfo['config_exists'] = $configExists;
$debugInfo['gasapi_exists'] = $gasApiExists;
$debugInfo['line_user_id'] = $lineUserId;
$debugInfo['session_data'] = $_SESSION;

if ($configExists && $gasApiExists) {
    try {
    require_once $configPath;
    require_once $gasApiPath;
    
    // GasApiClientクラスが存在するかチェック
    if (!class_exists('GasApiClient')) {
        throw new Exception("GasApiClientクラスが見つかりません");
    }
    
    // 正しい初期化方法
    $gasApi = new GasApiClient(GAS_DEPLOYMENT_ID, GAS_API_KEY);
    $debugInfo['gasapi_created'] = true;
        
        // API呼び出し
        $result = $gasApi->getUserFullInfo($lineUserId);
        $debugInfo['api_result'] = $result;
        
        if ($result['docsinfo'] === 'success' && isset($result['data']['docsinfo'])) {
            $docsData = $result['data']['docsinfo'];
            $debugInfo['docs_count'] = count($docsData);
        } elseif ($result['docsinfo'] === 'error') {
            $hasError = true;
            $errorMessage = $result['error']['message'] ?? '書類の取得に失敗しました。';
        } else {
            // 成功だが書類データなし
            $debugInfo['no_docsinfo'] = true;
        }
        
    } catch (Exception $e) {
        $hasError = true;
        $errorMessage = '書類データの取得中にエラーが発生しました: ' . $e->getMessage();
        $debugInfo['exception'] = $e->getMessage();
        $debugInfo['exception_trace'] = $e->getTraceAsString();
    }
} else {
    $hasError = true;
    $errorMessage = '必要なファイルが見つかりません。';
    if (!$configExists) $errorMessage .= ' config.php';
    if (!$gasApiExists) $errorMessage .= ' GasApiClient.php';
}

// Google DriveのURLをプレビュー用に変換する関数
function convertToPreviewUrl($url) {
    if (empty($url)) return '';
    
    if (preg_match('/\/d\/([a-zA-Z0-9-_]+)/', $url, $matches)) {
        $fileId = $matches[1];
        return "https://drive.google.com/file/d/{$fileId}/preview";
    }
    return $url;
}

// 日付をフォーマットする関数
function formatDate($dateString) {
    if (empty($dateString)) return '日付不明';
    
    try {
        $date = new DateTime($dateString);
        return $date->format('Y年m月d日');
    } catch (Exception $e) {
        return $dateString;
    }
}

// プレビューが可能かチェックする関数
function canPreview($url) {
    return !empty($url) && strpos($url, 'drive.google.com') !== false;
}
?>
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CLUTIREFINEクリニック 書類一覧 (デバッグ版)</title>
<meta name="description" content="CLUTIREFINEクリニックの書類一覧">
<!-- Tailwind CSS CDN --> 
<script src="https://cdn.tailwindcss.com"></script>
<style>
.debug-info {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    margin: 1rem 0;
    font-family: monospace;
    font-size: 0.875rem;
}
.debug-info pre {
    white-space: pre-wrap;
    word-break: break-all;
}
</style>
</head>
<body>
<!-- Header -->
<header class="bg-teal-600 text-white p-4 shadow-md sticky top-0 z-50">
  <div class="container mx-auto flex justify-between items-center">
    <h1 class="text-xl font-semibold">CLUTIREFINEクリニック<br class="sp">
      書類一覧 (デバッグ版)</h1>
  </div>
</header>

<!-- Main Content -->
<main class="flex-1 py-6 min-h-screen bg-gray-100">
  <div class="container mx-auto px-4">
    
    <!-- デバッグ情報 -->
    <div class="debug-info mb-6">
      <h3 class="font-bold mb-2">🔍 デバッグ情報</h3>
      <pre><?php echo json_encode($debugInfo, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE); ?></pre>
    </div>

    <!-- エラー表示 -->
    <?php if ($hasError): ?>
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        <h4 class="font-bold">エラーが発生しました</h4>
        <p><?php echo htmlspecialchars($errorMessage, ENT_QUOTES, 'UTF-8'); ?></p>
      </div>
    <?php endif; ?>

    <!-- 書類一覧 -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-2xl font-bold mb-4">書類一覧</h2>
      
      <?php if (!$hasError && empty($docsData)): ?>
        <div class="bg-gray-100 border border-gray-300 text-gray-600 px-4 py-6 rounded text-center">
          <p>現在、書類がありません。</p>
        </div>
      <?php endif; ?>

      <?php if (!$hasError && !empty($docsData)): ?>
        <div class="mb-4">
          <p class="text-sm text-gray-600">書類件数: <?php echo count($docsData); ?>件</p>
        </div>

        <div class="space-y-4">
          <?php foreach ($docsData as $index => $doc): ?>
            <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <h3 class="font-medium text-gray-900 mb-1">書類名</h3>
                  <p class="text-gray-700"><?php echo htmlspecialchars($doc['docs_name'] ?? '名称未設定', ENT_QUOTES, 'UTF-8'); ?></p>
                  <p class="text-xs text-gray-500 mt-1">
                    ID: <?php echo htmlspecialchars($doc['docs_id'] ?? '', ENT_QUOTES, 'UTF-8'); ?>
                  </p>
                </div>
                
                <div>
                  <h3 class="font-medium text-gray-900 mb-1">作成日</h3>
                  <p class="text-gray-700">
                    <?php 
                    if (isset($doc['created_at'])) {
                      echo htmlspecialchars(formatDate($doc['created_at']), ENT_QUOTES, 'UTF-8');
                    } else {
                      echo '日付不明';
                    }
                    ?>
                  </p>
                </div>
                
                <div class="flex items-center">
                  <?php if (isset($doc['docs_url']) && canPreview($doc['docs_url'])): ?>
                    <a class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors" 
                       href="<?php echo htmlspecialchars(convertToPreviewUrl($doc['docs_url']), ENT_QUOTES, 'UTF-8'); ?>" 
                       target="_blank" 
                       rel="noopener noreferrer">
                      プレビューを見る
                    </a>
                  <?php else: ?>
                    <span class="bg-gray-400 text-white px-4 py-2 rounded cursor-not-allowed">
                      プレビュー不可
                    </span>
                  <?php endif; ?>
                </div>
              </div>
              
              <!-- 個別の書類デバッグ情報 -->
              <details class="mt-4">
                <summary class="cursor-pointer text-sm text-gray-500">書類データの詳細</summary>
                <pre class="mt-2 text-xs bg-gray-100 p-2 rounded"><?php echo json_encode($doc, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE); ?></pre>
              </details>
            </div>
          <?php endforeach; ?>
        </div>
      <?php endif; ?>
    </div>

    <!-- 環境情報 -->
    <div class="debug-info mt-6">
      <h3 class="font-bold mb-2">🌍 環境情報</h3>
      <ul class="space-y-1">
        <li>PHP Version: <?php echo PHP_VERSION; ?></li>
        <li>Current Directory: <?php echo __DIR__; ?></li>
        <li>Include Path: <?php echo get_include_path(); ?></li>
        <li>Memory Usage: <?php echo memory_get_usage(true) / 1024 / 1024; ?> MB</li>
        <li>Session ID: <?php echo session_id(); ?></li>
      </ul>
    </div>
  </div>
</main>

<script>
console.log('デバッグ情報:', <?php echo json_encode($debugInfo); ?>);
</script>

</body>
</html>