# CULTIReFINE 予約システム 全体仕様書

## 1. システム概要

CULTIReFINEクリニック向けのLINE連携型Web予約システムです。患者がLINEアカウントでログインし、施術の予約、書類確認、チケット管理を行うことができます。

### 1.1 システムの特徴
- LINE認証による簡単ログイン
- 会社単位での患者管理（本会員・サブ会員）
- Medical Forceとの外部連携
- Google Sheetsをデータストアとして使用
- リアルタイム空き状況確認

## 2. システム構成

### 2.1 アーキテクチャ図

```
┌─────────────────┐      ┌──────────────────┐      ┌─────────────────┐
│   患者（User）   │      │  LINE Platform   │      │ Medical Force   │
│                 │      │                  │      │     (外部)      │
└────────┬────────┘      └────────┬─────────┘      └────────┬────────┘
         │                         │                         │
         │ HTTPS                   │ OAuth 2.0              │ API
         │                         │                         │
         ▼                         ▼                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    PHP Web Application                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐    │
│  │ LINE Auth    │  │ API Bridge   │  │ Medical Force    │    │
│  │ (OAuth)      │  │              │  │ API Client       │    │
│  └──────────────┘  └──────┬───────┘  └──────────────────┘    │
│                            │                                    │
└────────────────────────────┼────────────────────────────────────┘
                             │ HTTPS (Bearer Token)
                             ▼
                    ┌─────────────────┐
                    │   GAS Web API   │
                    │                 │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ Google Sheets   │
                    │  (Database)     │
                    └─────────────────┘
```

### 2.2 技術スタック

| レイヤー | 技術 | 用途 |
|---------|------|------|
| フロントエンド | HTML5, CSS3 (Tailwind), JavaScript (ES6) | SPA型予約画面 |
| バックエンド | PHP 8.x | セッション管理、API中継 |
| API | Google Apps Script | データ管理API |
| データストア | Google Sheets | 患者・予約データ |
| 認証 | LINE Login OAuth 2.0 | ユーザー認証 |
| 外部連携 | Medical Force API | 予約同期 |

## 3. 機能仕様

### 3.1 認証機能

#### 3.1.1 LINE認証フロー
1. ユーザーが「LINEでログイン」ボタンをクリック
2. LINE認証画面へリダイレクト
3. 認証成功後、コールバックURLへリダイレクト
4. アクセストークンを取得
5. ユーザープロフィールを取得
6. GAS APIで患者情報を照合・登録
7. セッション確立

#### 3.1.2 会員種別
- **本会員**: 全機能利用可能、他患者の公開設定変更可
- **サブ会員**: 公開設定された患者のみ閲覧可

### 3.2 予約機能

#### 3.2.1 予約フロー
```
患者選択 → メニュー選択 → 日時選択 → 確認 → 予約確定
    ↓           ↓            ↓         ↓        ↓
[単独/ペア/複数] [施術選択] [カレンダー] [内容確認] [API送信]
```

#### 3.2.2 予約タイプ
1. **単独予約**: 1名の患者の予約
2. **ペア予約**: 2名同室での予約
3. **複数予約**: 3名以上の一括予約

#### 3.2.3 空き状況確認
- Medical Force APIから空き枠を取得
- 5分単位のタイムスロット表示
- リアルタイム更新

### 3.3 患者管理機能

#### 3.3.1 患者情報
- 基本情報（氏名、カナ、性別）
- 会員種別（本会員/サブ会員/その他）
- 公開設定（本会員が管理）
- 最終来院日

#### 3.3.2 公開設定
- 本会員のみ変更可能
- サブ会員は公開患者のみ表示
- トグルボタンでリアルタイム変更

### 3.4 書類管理機能
- 同意書などの書類をオンライン確認
- PDFプレビュー機能
- ダウンロード可能

### 3.5 チケット管理機能
- 保有チケット数の確認
- 利用可能/予約済み/使用済みの内訳表示

## 4. API仕様

### 4.1 GAS API

#### 認証方式
- Bearer Token認証
- APIキーはスクリプトプロパティで管理

#### 主要エンドポイント

| メソッド | パス | 用途 |
|---------|------|------|
| GET | /api/users/line/{lineUserId}/full | ユーザー全情報取得 |
| GET | /api/patients/{patientId}/menus | 患者別メニュー取得 |
| POST | /api/visitors | 来院者新規登録 |
| POST | /api/reservations | 予約作成 |
| DELETE | /api/reservations/{id} | 予約キャンセル |

### 4.2 Medical Force API

#### 認証方式
- OAuth 2.0 Client Credentials
- JWTトークン（有効期限管理）

#### 主要エンドポイント

| メソッド | パス | 用途 |
|---------|------|------|
| POST | /oauth/token | アクセストークン取得 |
| GET | /api/v2/vacancies | 空き状況取得 |
| POST | /api/v2/visitors | 来院者登録 |
| POST | /api/v2/reservations | 予約作成 |

### 4.3 PHP API Bridge

#### 役割
- フロントエンドとGAS APIの中継
- セッション管理
- エラーハンドリング

#### エンドポイント
```
/reserve/api-bridge.php?action={action}
```

## 5. データモデル

### 5.1 主要データ構造

#### ユーザー（Users）
```javascript
{
  "id": "string",
  "line_user_id": "string",
  "name": "string",
  "email": "string",
  "phone": "string",
  "company_id": "string",
  "member_type": "main|sub",
  "created_at": "datetime"
}
```

#### 来院者（Visitors）
```javascript
{
  "visitor_id": "string",
  "company_id": "string",
  "name": "string",
  "kana": "string",
  "gender": "male|female",
  "member_type": "main|sub|null",
  "is_public": boolean,
  "last_visit_date": "date"
}
```

#### 予約（Reservations）
```javascript
{
  "reservation_id": "string",
  "visitor_id": "string",
  "menu_id": "string",
  "start_at": "datetime",
  "end_at": "datetime",
  "room_id": "string",
  "status": "confirmed|cancelled",
  "is_pair_booking": boolean
}
```

### 5.2 Google Sheets構成

| シート名 | 用途 | 主要カラム |
|---------|------|-----------|
| ユーザー | LINE認証ユーザー | LINE_ID, 氏名, 会社ID |
| 会社別来院者 | 患者マスタ | 患者ID, 会社ID, 氏名, 公開設定 |
| 予約 | 予約データ | 予約ID, 患者ID, 施術ID, 日時 |
| 施術履歴 | 過去の施術記録 | 患者ID, 施術ID, 実施日 |
| チケット | チケット管理 | 患者ID, チケット種別, 残数 |

## 6. セキュリティ仕様

### 6.1 認証・認可
- LINE OAuth 2.0によるユーザー認証
- セッションベースの状態管理
- Bearer Token認証（API間通信）
- 会員種別による権限制御

### 6.2 データ保護
- HTTPS通信の強制
- APIキーの環境変数管理
- セッションハイジャック対策
- XSS/CSRF対策

### 6.3 ログ管理
- アクセスログ
- エラーログ
- API通信ログ（デバッグモード時）

## 7. エラーハンドリング

### 7.1 エラーコード体系

| コード | 意味 | 対処 |
|--------|------|------|
| 401 | 認証エラー | 再ログイン |
| 403 | 権限エラー | 権限確認 |
| 404 | データなし | データ確認 |
| 409 | 競合エラー | 再試行 |
| 500 | サーバーエラー | サポート連絡 |

### 7.2 ユーザー向けエラーメッセージ
- 技術的でない分かりやすい表現
- 具体的な対処方法の提示
- サポート連絡先の表示

## 8. パフォーマンス要件

### 8.1 レスポンスタイム
- 画面遷移: 3秒以内
- API応答: 2秒以内
- 検索処理: 5秒以内

### 8.2 同時接続数
- 想定: 最大100ユーザー
- ピーク時: 50リクエスト/分

### 8.3 データ容量
- Google Sheets制限: 1000万セル
- 画像アップロード: なし
- セッション保持: 24時間

## 9. 運用・保守

### 9.1 バックアップ
- Google Sheets: 自動バックアップ
- コード: Git管理
- 設定: 環境変数

### 9.2 監視項目
- APIエラー率
- レスポンスタイム
- セッション数
- Medical Force同期状態

### 9.3 メンテナンス
- 定期: 毎月第3日曜日
- 緊急: 随時対応
- 通知: LINE配信

## 10. 今後の拡張予定

### 10.1 機能追加
- プッシュ通知
- 予約リマインダー
- オンライン問診
- 決済連携

### 10.2 連携拡張
- 電子カルテ連携
- 会計システム連携
- 在庫管理連携

## 更新履歴
- 2025-01-28: 初版作成