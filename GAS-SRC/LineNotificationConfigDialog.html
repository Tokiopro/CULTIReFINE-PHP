<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 30px;
    }
    h1 {
      color: #333;
      margin-bottom: 30px;
      font-size: 24px;
      border-bottom: 2px solid #00b900;
      padding-bottom: 10px;
    }
    .tabs {
      display: flex;
      border-bottom: 2px solid #e0e0e0;
      margin-bottom: 30px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 16px;
      color: #666;
      transition: all 0.3s;
    }
    .tab:hover {
      color: #00b900;
    }
    .tab.active {
      color: #00b900;
      border-bottom: 3px solid #00b900;
      margin-bottom: -2px;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .section-title {
      font-size: 18px;
      font-weight: bold;
      color: #00b900;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-row {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    label {
      display: inline-block;
      width: 200px;
      font-weight: 500;
      color: #555;
    }
    input[type="text"], input[type="time"], select, textarea {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      width: 300px;
    }
    textarea {
      width: 100%;
      min-height: 200px;
      font-family: monospace;
      resize: vertical;
    }
    input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #00b900;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 30px;
      justify-content: center;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .btn-primary {
      background-color: #00b900;
      color: white;
    }
    .btn-primary:hover {
      background-color: #009900;
    }
    .btn-secondary {
      background-color: #f1f3f4;
      color: #5f6368;
    }
    .btn-secondary:hover {
      background-color: #e8eaed;
    }
    .btn-danger {
      background-color: #ea4335;
      color: white;
    }
    .btn-danger:hover {
      background-color: #d33b2c;
    }
    .preview-section {
      margin-top: 20px;
      padding: 20px;
      background-color: #f0f7ff;
      border-radius: 8px;
      border: 1px solid #00b900;
    }
    .preview-title {
      font-size: 16px;
      font-weight: bold;
      color: #00b900;
      margin-bottom: 15px;
    }
    .preview-content {
      padding: 15px;
      background-color: white;
      border-radius: 4px;
      border: 1px solid #ddd;
      white-space: pre-wrap;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1.6;
    }
    .variable-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
      padding: 15px;
      background-color: #fff;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .variable-item {
      padding: 8px;
      background-color: #f5f5f5;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .variable-item:hover {
      background-color: #e0f0e0;
    }
    .variable-key {
      font-family: monospace;
      color: #00b900;
      font-weight: bold;
    }
    .variable-desc {
      color: #666;
      font-size: 11px;
      margin-top: 2px;
    }
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #00b900;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error {
      color: #ea4335;
      font-size: 14px;
      margin-top: 5px;
    }
    .success {
      color: #34a853;
      font-size: 14px;
      margin-top: 5px;
    }
    .info {
      background-color: #e8f0fe;
      border-left: 4px solid #00b900;
      padding: 10px 15px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #00b900;
    }
    .help-text {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }
    .template-editor {
      display: flex;
      gap: 20px;
    }
    .editor-left {
      flex: 1;
    }
    .editor-right {
      width: 300px;
    }
    .test-button {
      background-color: #ff9800;
      color: white;
      padding: 8px 16px;
      margin-left: 10px;
    }
    .test-button:hover {
      background-color: #f57c00;
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
  </div>

  <div class="container">
    <h1>ğŸ“± LINEé€šçŸ¥ç®¡ç†</h1>

    <div class="info">
      LINEé€šçŸ¥ã®è¨­å®šã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç®¡ç†ã—ã¾ã™ã€‚å„é€šçŸ¥ã‚¿ã‚¤ãƒ—ã”ã¨ã«é€ä¿¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ã€‚
    </div>

    <!-- ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('config')">é€šçŸ¥è¨­å®š</button>
      <button class="tab" onclick="switchTab('template')">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†</button>
      <button class="tab" onclick="switchTab('preview')">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
    </div>

    <!-- é€šçŸ¥è¨­å®šã‚¿ãƒ– -->
    <div id="configTab" class="tab-content active">
      <!-- äºˆç´„ç¢ºå®šé€šçŸ¥ -->
      <div class="section">
        <div class="section-title">âœ… äºˆç´„ç¢ºå®šæ™‚é€šçŸ¥</div>
        
        <div class="form-group">
          <div class="form-row">
            <label>é€šçŸ¥ã‚’é€ä¿¡</label>
            <label class="switch">
              <input type="checkbox" id="confirmEnabled" checked>
              <span class="slider"></span>
            </label>
            <span style="margin-left: 10px; color: #666;">äºˆç´„ç¢ºå®šæ™‚ã«è‡ªå‹•é€ä¿¡</span>
          </div>
          
          <div class="form-row">
            <label>é€ä¿¡å¯¾è±¡</label>
            <select id="confirmTarget">
              <option value="æ¥é™¢è€…">æ¥é™¢è€…ã®ã¿</option>
              <option value="äºˆç´„è€…">äºˆç´„è€…ã®ã¿</option>
              <option value="ä¸¡æ–¹">æ¥é™¢è€…ã¨äºˆç´„è€…</option>
            </select>
          </div>
          
          <div class="form-row">
            <label>ãƒã‚±ãƒƒãƒˆæƒ…å ±ã‚’å«ã‚€</label>
            <input type="checkbox" id="confirmIncludeTicket" checked>
            <span class="help-text">ãƒã‚±ãƒƒãƒˆæ¶ˆåŒ–æ•°ã¨æ®‹æ•°ã‚’è¡¨ç¤º</span>
          </div>
          
          <div class="form-row">
            <label>æ–½è¡“æ³¨æ„ç‚¹ã‚’å«ã‚€</label>
            <input type="checkbox" id="confirmIncludeNotes" checked>
            <span class="help-text">æ–½è¡“ã«é–¢ã™ã‚‹æ³¨æ„äº‹é …ã‚’è¡¨ç¤º</span>
          </div>
        </div>
      </div>

      <!-- å‰æ—¥ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ -->
      <div class="section">
        <div class="section-title">ğŸ“… äºˆç´„å‰æ—¥é€šçŸ¥</div>
        
        <div class="form-group">
          <div class="form-row">
            <label>é€šçŸ¥ã‚’é€ä¿¡</label>
            <label class="switch">
              <input type="checkbox" id="dayBeforeEnabled" checked>
              <span class="slider"></span>
            </label>
            <input type="time" id="dayBeforeTime" value="11:00" style="margin-left: 10px; width: 100px;">
            <span style="margin-left: 10px; color: #666;">ã«é€ä¿¡</span>
          </div>
          
          <div class="form-row">
            <label>é€ä¿¡å¯¾è±¡</label>
            <select id="dayBeforeTarget">
              <option value="æ¥é™¢è€…">æ¥é™¢è€…ã®ã¿</option>
              <option value="äºˆç´„è€…">äºˆç´„è€…ã®ã¿</option>
              <option value="ä¸¡æ–¹">æ¥é™¢è€…ã¨äºˆç´„è€…</option>
            </select>
          </div>
          
          <div class="form-row">
            <label>ãƒã‚±ãƒƒãƒˆæƒ…å ±ã‚’å«ã‚€</label>
            <input type="checkbox" id="dayBeforeIncludeTicket" checked>
          </div>
          
          <div class="form-row">
            <label>æ–½è¡“æ³¨æ„ç‚¹ã‚’å«ã‚€</label>
            <input type="checkbox" id="dayBeforeIncludeNotes" checked>
          </div>
        </div>
      </div>

      <!-- å½“æ—¥ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ -->
      <div class="section">
        <div class="section-title">â° äºˆç´„å½“æ—¥é€šçŸ¥</div>
        
        <div class="form-group">
          <div class="form-row">
            <label>é€šçŸ¥ã‚’é€ä¿¡</label>
            <label class="switch">
              <input type="checkbox" id="sameDayEnabled" checked>
              <span class="slider"></span>
            </label>
            <input type="time" id="sameDayTime" value="09:00" style="margin-left: 10px; width: 100px;">
            <span style="margin-left: 10px; color: #666;">ã«é€ä¿¡</span>
          </div>
          
          <div class="form-row">
            <label>é€ä¿¡å¯¾è±¡</label>
            <select id="sameDayTarget">
              <option value="æ¥é™¢è€…">æ¥é™¢è€…ã®ã¿</option>
              <option value="äºˆç´„è€…">äºˆç´„è€…ã®ã¿</option>
              <option value="ä¸¡æ–¹">æ¥é™¢è€…ã¨äºˆç´„è€…</option>
            </select>
          </div>
          
          <div class="form-row">
            <label>ãƒã‚±ãƒƒãƒˆæƒ…å ±ã‚’å«ã‚€</label>
            <input type="checkbox" id="sameDayIncludeTicket" checked>
          </div>
          
          <div class="form-row">
            <label>æ–½è¡“æ³¨æ„ç‚¹ã‚’å«ã‚€</label>
            <input type="checkbox" id="sameDayIncludeNotes" checked>
          </div>
        </div>
      </div>

      <!-- æ–½è¡“å¾Œé€šçŸ¥ -->
      <div class="section">
        <div class="section-title">âœ¨ æ–½è¡“å¾Œé€šçŸ¥</div>
        
        <div class="form-group">
          <div class="form-row">
            <label>é€šçŸ¥ã‚’é€ä¿¡</label>
            <label class="switch">
              <input type="checkbox" id="afterEnabled" checked>
              <span class="slider"></span>
            </label>
            <select id="afterTiming" style="margin-left: 10px; width: 150px;">
              <option value="1æ™‚é–“å¾Œ">1æ™‚é–“å¾Œ</option>
              <option value="2æ™‚é–“å¾Œ">2æ™‚é–“å¾Œ</option>
              <option value="3æ™‚é–“å¾Œ">3æ™‚é–“å¾Œ</option>
            </select>
            <span style="margin-left: 10px; color: #666;">ã«é€ä¿¡</span>
          </div>
          
          <div class="form-row">
            <label>é€ä¿¡å¯¾è±¡</label>
            <select id="afterTarget">
              <option value="æ¥é™¢è€…">æ¥é™¢è€…ã®ã¿</option>
              <option value="äºˆç´„è€…">äºˆç´„è€…ã®ã¿</option>
              <option value="ä¸¡æ–¹">æ¥é™¢è€…ã¨äºˆç´„è€…</option>
            </select>
          </div>
          
          <div class="form-row">
            <label>ãƒã‚±ãƒƒãƒˆæƒ…å ±ã‚’å«ã‚€</label>
            <input type="checkbox" id="afterIncludeTicket" checked>
            <span class="help-text">æ›´æ–°å¾Œã®æ®‹æ•°ã‚’è¡¨ç¤º</span>
          </div>
          
          <div class="form-row">
            <label>æ–½è¡“æ³¨æ„ç‚¹ã‚’å«ã‚€</label>
            <input type="checkbox" id="afterIncludeNotes">
            <span class="help-text">æ–½è¡“å¾Œã¯é€šå¸¸ä¸è¦</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†ã‚¿ãƒ– -->
    <div id="templateTab" class="tab-content">
      <div class="section">
        <div class="section-title">ğŸ“ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†</div>
        
        <div class="form-group">
          <div class="form-row">
            <label>é€šçŸ¥ã‚¿ã‚¤ãƒ—</label>
            <select id="templateType" onchange="loadTemplate()">
              <option value="äºˆç´„ç¢ºå®š">äºˆç´„ç¢ºå®š</option>
              <option value="äºˆç´„å‰æ—¥">äºˆç´„å‰æ—¥</option>
              <option value="äºˆç´„å½“æ—¥">äºˆç´„å½“æ—¥</option>
              <option value="æ–½è¡“å¾Œ">æ–½è¡“å¾Œ</option>
            </select>
          </div>
        </div>

        <div class="template-editor">
          <div class="editor-left">
            <label>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡:</label>
            <textarea id="templateBody" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
            <div class="help-text">
              å¤‰æ•°ã¯ ${å¤‰æ•°å} ã®å½¢å¼ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚æ¡ä»¶ä»˜ãè¡¨ç¤ºã¯ [ãƒã‚±ãƒƒãƒˆæƒ…å ±]ã€[æ³¨æ„äº‹é …]ã€[æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•] ãŒä½¿ç”¨ã§ãã¾ã™ã€‚
            </div>
          </div>
          
          <div class="editor-right">
            <label>ä½¿ç”¨å¯èƒ½ãªå¤‰æ•°:</label>
            <div class="variable-list" id="variableList">
              <!-- å¤‰æ•°ãƒªã‚¹ãƒˆãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ– -->
    <div id="previewTab" class="tab-content">
      <div class="section">
        <div class="section-title">ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
        
        <div class="form-group">
          <div class="form-row">
            <label>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹é€šçŸ¥</label>
            <select id="previewType">
              <option value="äºˆç´„ç¢ºå®š">äºˆç´„ç¢ºå®š</option>
              <option value="äºˆç´„å‰æ—¥">äºˆç´„å‰æ—¥</option>
              <option value="äºˆç´„å½“æ—¥">äºˆç´„å½“æ—¥</option>
              <option value="æ–½è¡“å¾Œ">æ–½è¡“å¾Œ</option>
            </select>
            <button class="test-button" onclick="generatePreview()">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ</button>
            <button class="test-button" onclick="sendTestMessage()">ãƒ†ã‚¹ãƒˆé€ä¿¡</button>
          </div>
        </div>

        <div class="preview-section" id="previewSection" style="display: none;">
          <div class="preview-title">ğŸ“± ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
          <div class="preview-content" id="previewContent">
            <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— -->
    <div class="button-group">
      <button class="btn-primary" onclick="saveAll()">ä¿å­˜</button>
      <button class="btn-secondary" onclick="loadAll()">è¨­å®šã‚’å†èª­ã¿è¾¼ã¿</button>
      <button class="btn-secondary" onclick="initializeTemplates()">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåˆæœŸåŒ–</button>
      <button class="btn-secondary" onclick="google.script.host.close()">é–‰ã˜ã‚‹</button>
    </div>

    <div id="message"></div>
  </div>

  <script>
    // åˆæœŸåŒ–
    window.onload = function() {
      loadAll();
      loadVariableList();
    };

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchTab(tabName) {
      // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºã‚’æ›´æ–°
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName + 'Tab').classList.add('active');
    }

    // å…¨è¨­å®šã‚’èª­ã¿è¾¼ã¿
    function loadAll() {
      showLoading(true);
      google.script.run
        .withSuccessHandler(function(data) {
          showLoading(false);
          applyConfigs(data.configs);
          applyTemplates(data.templates);
          showMessage('è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          showMessage('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'error');
        })
        .loadLineNotificationSettings();
    }

    // è¨­å®šã‚’ç”»é¢ã«åæ˜ 
    function applyConfigs(configs) {
      configs.forEach(config => {
        switch(config.type) {
          case 'äºˆç´„ç¢ºå®š':
            document.getElementById('confirmEnabled').checked = config.enabled;
            document.getElementById('confirmTarget').value = config.target;
            document.getElementById('confirmIncludeTicket').checked = config.includeTicket;
            document.getElementById('confirmIncludeNotes').checked = config.includeNotes;
            break;
          case 'äºˆç´„å‰æ—¥':
            document.getElementById('dayBeforeEnabled').checked = config.enabled;
            document.getElementById('dayBeforeTime').value = config.timing || '11:00';
            document.getElementById('dayBeforeTarget').value = config.target;
            document.getElementById('dayBeforeIncludeTicket').checked = config.includeTicket;
            document.getElementById('dayBeforeIncludeNotes').checked = config.includeNotes;
            break;
          case 'äºˆç´„å½“æ—¥':
            document.getElementById('sameDayEnabled').checked = config.enabled;
            document.getElementById('sameDayTime').value = config.timing || '09:00';
            document.getElementById('sameDayTarget').value = config.target;
            document.getElementById('sameDayIncludeTicket').checked = config.includeTicket;
            document.getElementById('sameDayIncludeNotes').checked = config.includeNotes;
            break;
          case 'æ–½è¡“å¾Œ':
            document.getElementById('afterEnabled').checked = config.enabled;
            document.getElementById('afterTiming').value = config.timing || '1æ™‚é–“å¾Œ';
            document.getElementById('afterTarget').value = config.target;
            document.getElementById('afterIncludeTicket').checked = config.includeTicket;
            document.getElementById('afterIncludeNotes').checked = config.includeNotes;
            break;
        }
      });
    }

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”»é¢ã«åæ˜ 
    function applyTemplates(templates) {
      window.templates = templates;
      loadTemplate();
    }

    // é¸æŠã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
    function loadTemplate() {
      const type = document.getElementById('templateType').value;
      const template = window.templates.find(t => t.type === type);
      if (template) {
        document.getElementById('templateBody').value = template.body;
      }
    }

    // å¤‰æ•°ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
    function loadVariableList() {
      google.script.run
        .withSuccessHandler(function(variables) {
          const container = document.getElementById('variableList');
          container.innerHTML = '';
          
          variables.forEach(variable => {
            const item = document.createElement('div');
            item.className = 'variable-item';
            item.onclick = function() {
              insertVariable(variable.key);
            };
            item.innerHTML = `
              <div class="variable-key">${variable.key}</div>
              <div class="variable-desc">${variable.description}</div>
            `;
            container.appendChild(item);
          });
        })
        .withFailureHandler(function(error) {
          console.error('å¤‰æ•°ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getAvailableVariables();
    }

    // å¤‰æ•°ã‚’ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«æŒ¿å…¥
    function insertVariable(variable) {
      const textarea = document.getElementById('templateBody');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      
      textarea.value = text.substring(0, start) + variable + text.substring(end);
      textarea.selectionStart = textarea.selectionEnd = start + variable.length;
      textarea.focus();
    }

    // å…¨è¨­å®šã‚’ä¿å­˜
    function saveAll() {
      const configs = [
        {
          type: 'äºˆç´„ç¢ºå®š',
          enabled: document.getElementById('confirmEnabled').checked,
          timing: 'å³æ™‚',
          target: document.getElementById('confirmTarget').value,
          includeTicket: document.getElementById('confirmIncludeTicket').checked,
          includeNotes: document.getElementById('confirmIncludeNotes').checked
        },
        {
          type: 'äºˆç´„å‰æ—¥',
          enabled: document.getElementById('dayBeforeEnabled').checked,
          timing: document.getElementById('dayBeforeTime').value,
          target: document.getElementById('dayBeforeTarget').value,
          includeTicket: document.getElementById('dayBeforeIncludeTicket').checked,
          includeNotes: document.getElementById('dayBeforeIncludeNotes').checked
        },
        {
          type: 'äºˆç´„å½“æ—¥',
          enabled: document.getElementById('sameDayEnabled').checked,
          timing: document.getElementById('sameDayTime').value,
          target: document.getElementById('sameDayTarget').value,
          includeTicket: document.getElementById('sameDayIncludeTicket').checked,
          includeNotes: document.getElementById('sameDayIncludeNotes').checked
        },
        {
          type: 'æ–½è¡“å¾Œ',
          enabled: document.getElementById('afterEnabled').checked,
          timing: document.getElementById('afterTiming').value,
          target: document.getElementById('afterTarget').value,
          includeTicket: document.getElementById('afterIncludeTicket').checked,
          includeNotes: document.getElementById('afterIncludeNotes').checked
        }
      ];

      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚‚æ›´æ–°
      const currentType = document.getElementById('templateType').value;
      const currentTemplate = window.templates.find(t => t.type === currentType);
      if (currentTemplate) {
        currentTemplate.body = document.getElementById('templateBody').value;
      }

      showLoading(true);
      google.script.run
        .withSuccessHandler(function() {
          showLoading(false);
          showMessage('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          showMessage('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'error');
        })
        .saveLineNotificationSettings(configs, window.templates);
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ
    function generatePreview() {
      const type = document.getElementById('previewType').value;
      
      showLoading(true);
      google.script.run
        .withSuccessHandler(function(preview) {
          showLoading(false);
          showPreview(preview);
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          showMessage('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'error');
        })
        .generateNotificationPreview(type);
    }

    // ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    function sendTestMessage() {
      const type = document.getElementById('previewType').value;
      
      if (!confirm(`ã€Œ${type}ã€ã®ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }
      
      showLoading(true);
      google.script.run
        .withSuccessHandler(function(result) {
          showLoading(false);
          if (result.success) {
            showMessage('ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
          } else {
            showMessage('ãƒ†ã‚¹ãƒˆé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          showMessage('ãƒ†ã‚¹ãƒˆé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'error');
        })
        .sendTestNotification(type);
    }

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåˆæœŸåŒ–
    function initializeTemplates() {
      if (!confirm('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®è¨­å®šã¯å¤±ã‚ã‚Œã¾ã™ã€‚')) {
        return;
      }
      
      showLoading(true);
      google.script.run
        .withSuccessHandler(function() {
          showLoading(false);
          loadAll();
          showMessage('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ', 'success');
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          showMessage('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'error');
        })
        .initializeNotificationTemplates();
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    function showPreview(content) {
      document.getElementById('previewSection').style.display = 'block';
      
      let previewHtml = '';
      
      // ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      if (content.message) {
        previewHtml += '<h4>ğŸ“± ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h4>';
        previewHtml += '<div style="padding: 15px; background: #e8f4fd; border-radius: 8px; margin-bottom: 20px; white-space: pre-wrap;">';
        previewHtml += content.message;
        previewHtml += '</div>';
      }
      
      // FlexMessageãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      if (content.flexMessage) {
        previewHtml += '<h4>ğŸ¨ FlexMessage</h4>';
        previewHtml += '<div style="margin-bottom: 10px; font-size: 12px; color: #666;">PHPãŒLINE Messaging APIã§é€ä¿¡ã™ã‚‹FlexMessageå½¢å¼</div>';
        previewHtml += '<pre style="margin: 0; white-space: pre-wrap; font-size: 12px; background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto;">';
        previewHtml += JSON.stringify(content.flexMessage, null, 2);
        previewHtml += '</pre>';
      } else {
        // å¾“æ¥ã®JSONè¡¨ç¤º
        previewHtml += '<pre style="margin: 0; white-space: pre-wrap;">';
        previewHtml += JSON.stringify(content, null, 2);
        previewHtml += '</pre>';
      }
      
      document.getElementById('previewContent').innerHTML = previewHtml;
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'flex' : 'none';
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showMessage(message, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.className = type;
      messageDiv.textContent = message;
      setTimeout(() => {
        messageDiv.textContent = '';
        messageDiv.className = '';
      }, 5000);
    }
  </script>
</body>
</html>