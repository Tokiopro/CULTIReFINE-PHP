# 予約同期処理の最適化 - 実装概要

## 背景と問題点

Medical Force APIからの予約データ同期がGoogle Apps Script (GAS)の6分実行時間制限でタイムアウトしていた問題を解決しました。

### 元々の問題
- 3ヶ月分（90日）のデータ同期で6分を超過
- 並列処理の実装が複雑で保守性が低い
- PHP経由の同期も結局タイムアウト

### 根本原因の分析
1. **データ量** - 処理の複雑さではなく、単純にAPIコール数が多い
2. **不要な処理** - 同期時に会社情報検索など重い処理を実行
3. **非効率な書き込み** - 全データをクリアして書き直し

## 実装した解決策

### 1. 同期範囲の最適化
```javascript
// 変更前
日次: 過去7日～今後7日 (14日間)
週次: 過去30日～今後30日 (60日間) 
月次: 今日～3ヶ月後 (90日間)

// 変更後
日次: 今日～7日後 (7日間)
週次: 今日～14日後 (14日間)
月次: 今日～30日後 (30日間)
```

### 2. 新しい最適化同期メソッド
`syncReservationsOptimized()` を実装：
- 既存予約IDをチェックして重複を回避
- 新規/更新分のみを追加（差分同期）
- 4分でタイムアウト（安全マージン確保）
- API待機時間を50msに短縮

### 3. データ変換の簡略化
`_reservationToRowOptimized()` を実装：
- 会社情報の検索を省略（必要時に別途取得）
- 患者属性の計算を省略
- 部屋情報などの詳細も省略

### 4. 削除したコンポーネント
- `ParallelReservationService.js` - 不要
- PHP経由の同期メソッド - 不要
- 並列処理関連のトリガー機能 - 不要

## 効果

1. **シンプルな実装** - 並列処理の複雑さを排除
2. **高速化** - 差分同期により処理時間を大幅短縮
3. **安定性** - タイムアウトリスクを排除
4. **保守性** - コードベースを大幅に簡略化

## 使用方法

### 自動同期（トリガー）
```javascript
// 日次（毎日午前2時）
runDailyReservationSync()  // 今日～7日後

// 週次（毎週日曜日午前3時）
runWeeklyReservationSync()  // 今日～14日後

// 月次（毎月1日午前4時）
runMonthlyReservationSync()  // 今日～30日後
```

### 手動同期（デバッグ用）
```javascript
// 標準的な手動同期
manualReservationSync()  // 今日～7日後

// 特定期間の同期
syncDateRange('2025-01-01', '2025-01-31')

// 今日のみ同期
syncToday()
```

## 技術的詳細

### タイムアウト対策
1. データ範囲を必要最小限に限定
2. 差分同期で処理量を削減
3. 不要な変換処理を削除
4. 4分でのタイムアウト設定（2分の余裕）

### パフォーマンス改善
1. 既存IDのSetを使用した高速重複チェック
2. バッチ書き込みによるI/O最適化
3. API待機時間の最適化（100ms→50ms）

## 今後の推奨事項

1. **定期的なデータクリーンアップ** - 古いデータの定期削除
2. **インクリメンタル同期の活用** - 更新日時ベースの同期
3. **キャッシュの活用** - 頻繁にアクセスするデータのキャッシュ
4. **監視の強化** - 同期メトリクスの定期確認

この最適化により、6分のタイムアウト問題を根本的に解決し、よりシンプルで保守しやすいシステムになりました。