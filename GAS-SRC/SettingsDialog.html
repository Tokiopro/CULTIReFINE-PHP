<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        margin: 0;
      }
      
      .container {
        max-width: 100%;
        margin: 0 auto;
      }
      
      h2 {
        color: #333;
        margin-bottom: 20px;
        border-bottom: 2px solid #4285f4;
        padding-bottom: 10px;
      }
      
      h3 {
        color: #555;
        margin-top: 25px;
        margin-bottom: 15px;
      }
      
      .section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 20px;
      }
      
      .form-group {
        margin-bottom: 15px;
      }
      
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #555;
      }
      
      input[type="text"],
      input[type="password"],
      input[type="number"],
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
      }
      
      input[type="text"]:focus,
      input[type="password"]:focus,
      input[type="number"]:focus,
      select:focus {
        outline: none;
        border-color: #4285f4;
        box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
      }
      
      button {
        padding: 10px 20px;
        font-size: 14px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
      }
      
      .save-btn {
        background-color: #4285f4;
        color: white;
      }
      
      .save-btn:hover {
        background-color: #357ae8;
      }
      
      .clear-btn {
        background-color: #db4437;
        color: white;
      }
      
      .clear-btn:hover {
        background-color: #c23321;
      }
      
      .close-btn {
        background-color: #666;
        color: white;
      }
      
      .close-btn:hover {
        background-color: #555;
      }
      
      .status {
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
        display: none;
      }
      
      .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      
      .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      
      .info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      
      .status-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }
      
      .status-item:last-child {
        border-bottom: none;
      }
      
      .status-label {
        font-weight: bold;
        color: #555;
      }
      
      .status-value {
        color: #333;
      }
      
      .status-ok {
        color: #28a745;
      }
      
      .status-missing {
        color: #dc3545;
      }
      
      .help-text {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }
      
      #loading {
        display: none;
        text-align: center;
        padding: 20px;
      }
      
      .button-group {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #ddd;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Medical Force連携 設定</h2>
      
      <div id="loading">読み込み中...</div>
      
      <div id="content" style="display: none;">
        <!-- 認証情報セクション -->
        <div class="section">
          <h3>認証情報</h3>
          
          <div class="info" style="display: block; margin-bottom: 15px;">
            <strong>注意:</strong> 認証情報は一度設定すると、セキュリティ上の理由からこの画面では変更できません。
            変更が必要な場合は、スクリプトプロパティから直接編集してください。
          </div>
          
          <div class="status-item">
            <span class="status-label">Client ID:</span>
            <span id="clientIdStatus" class="status-value"></span>
          </div>
          <div class="status-item">
            <span class="status-label">Client Secret:</span>
            <span id="clientSecretStatus" class="status-value"></span>
          </div>
          <div class="status-item">
            <span class="status-label">アクセストークン:</span>
            <span id="tokenStatus" class="status-value"></span>
          </div>
          <div class="status-item">
            <span class="status-label">トークン有効期限:</span>
            <span id="tokenExpiryStatus" class="status-value"></span>
          </div>
          
          <div id="newCredentials" style="display: none; margin-top: 15px;">
            <div class="form-group">
              <label for="clientId">Client ID:</label>
              <input type="text" id="clientId" placeholder="Medical ForceのClient IDを入力">
            </div>
            
            <div class="form-group">
              <label for="clientSecret">Client Secret:</label>
              <input type="password" id="clientSecret" placeholder="Medical ForceのClient Secretを入力">
            </div>
          </div>
          
          <button class="clear-btn" onclick="clearTokenCache()" style="margin-top: 15px;">
            トークンキャッシュをクリア
          </button>
          <span class="help-text">※ 認証エラーが発生した場合に実行してください</span>
        </div>
        
        <!-- 基本設定セクション -->
        <div class="section">
          <h3>基本設定</h3>
          
          <div class="form-group">
            <label for="clinicId">クリニックID:</label>
            <input type="text" id="clinicId" placeholder="例: 12345">
            <span class="help-text">Medical Forceで割り当てられたクリニックIDを入力してください</span>
          </div>
        </div>
        
        <!-- 同期設定セクション -->
        <div class="section">
          <h3>同期設定</h3>
          
          <div class="form-group">
            <label for="syncInterval">自動同期間隔:</label>
            <select id="syncInterval">
              <option value="hourly">1時間ごと</option>
              <option value="daily">1日ごと</option>
              <option value="manual">手動のみ</option>
            </select>
            <span class="help-text">データの自動同期頻度を設定します</span>
          </div>
          
          <div class="form-group">
            <label for="maxRecords">最大取得件数:</label>
            <input type="number" id="maxRecords" min="10" max="1000" step="10" value="100">
            <span class="help-text">一度の同期で取得する最大レコード数（10〜1000）</span>
          </div>
        </div>
        
        <div id="statusMessage" class="status"></div>
        
        <div class="button-group">
          <button class="save-btn" onclick="saveSettings()">設定を保存</button>
          <button class="close-btn" onclick="google.script.host.close()">閉じる</button>
        </div>
      </div>
    </div>
    
    <script>
      // ページ読み込み時に設定を取得
      window.onload = function() {
        loadSettings();
      };
      
      function loadSettings() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('content').style.display = 'none';
        
        google.script.run
          .withSuccessHandler(function(settings) {
            // 認証情報の状態を表示
            document.getElementById('clientIdStatus').textContent = 
              settings.hasClientId ? '設定済み' : '未設定';
            document.getElementById('clientIdStatus').className = 
              settings.hasClientId ? 'status-value status-ok' : 'status-value status-missing';
            
            document.getElementById('clientSecretStatus').textContent = 
              settings.hasClientSecret ? '設定済み' : '未設定';
            document.getElementById('clientSecretStatus').className = 
              settings.hasClientSecret ? 'status-value status-ok' : 'status-value status-missing';
            
            document.getElementById('tokenStatus').textContent = 
              settings.hasAccessToken ? '取得済み' : '未取得';
            document.getElementById('tokenStatus').className = 
              settings.hasAccessToken ? 'status-value status-ok' : 'status-value status-missing';
            
            if (settings.tokenExpiry) {
              const expiry = new Date(settings.tokenExpiry);
              const now = new Date();
              const isExpired = expiry < now;
              document.getElementById('tokenExpiryStatus').textContent = 
                expiry.toLocaleString('ja-JP') + (isExpired ? ' (期限切れ)' : '');
              document.getElementById('tokenExpiryStatus').className = 
                isExpired ? 'status-value status-missing' : 'status-value status-ok';
            } else {
              document.getElementById('tokenExpiryStatus').textContent = '-';
              document.getElementById('tokenExpiryStatus').className = 'status-value';
            }
            
            // 認証情報が未設定の場合は入力欄を表示
            if (!settings.hasClientId || !settings.hasClientSecret) {
              document.getElementById('newCredentials').style.display = 'block';
            }
            
            // その他の設定を表示
            document.getElementById('clinicId').value = settings.clinicId;
            document.getElementById('syncInterval').value = settings.syncInterval;
            document.getElementById('maxRecords').value = settings.maxRecords;
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
          })
          .withFailureHandler(function(error) {
            showStatus('設定の読み込みに失敗しました: ' + error, 'error');
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
          })
          .getSettingsForDialog();
      }
      
      function saveSettings() {
        const settings = {
          clinicId: document.getElementById('clinicId').value,
          syncInterval: document.getElementById('syncInterval').value,
          maxRecords: document.getElementById('maxRecords').value
        };
        
        // 新規認証情報がある場合は追加
        const clientId = document.getElementById('clientId').value;
        const clientSecret = document.getElementById('clientSecret').value;
        if (clientId) settings.clientId = clientId;
        if (clientSecret) settings.clientSecret = clientSecret;
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              showStatus(result.message, 'success');
              // 認証情報を設定した場合はリロード
              if (clientId || clientSecret) {
                setTimeout(function() {
                  loadSettings();
                }, 1000);
              }
            } else {
              showStatus('保存に失敗しました: ' + result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            showStatus('エラーが発生しました: ' + error, 'error');
          })
          .saveSettingsFromDialog(settings);
      }
      
      function clearTokenCache() {
        if (confirm('トークンキャッシュをクリアしますか？\n次回のAPI呼び出し時に新しいトークンが取得されます。')) {
          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                showStatus(result.message, 'success');
                setTimeout(function() {
                  loadSettings();
                }, 1000);
              } else {
                showStatus('クリアに失敗しました: ' + result.message, 'error');
              }
            })
            .withFailureHandler(function(error) {
              showStatus('エラーが発生しました: ' + error, 'error');
            })
            .clearTokenCacheFromDialog();
        }
      }
      
      function showStatus(message, type) {
        const statusDiv = document.getElementById('statusMessage');
        statusDiv.textContent = message;
        statusDiv.className = 'status ' + type;
        statusDiv.style.display = 'block';
        
        if (type === 'success') {
          setTimeout(function() {
            statusDiv.style.display = 'none';
          }, 3000);
        }
      }
    </script>
  </body>
</html>